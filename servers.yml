Description: >
    Artem Telesh / Cloud DevOps Engineer Nanodegree
    Project 2.
Parameters:
    # whatever you consider a changing value, put it as a parameter instead of hard-coding it into your script
    EnvironmentName:
        Description: Name of environment to prefix to resource names
        Type: String

Resources:
    LBSecurityGroup:
        Type: AWS::EC2::SecurityGroup
        Properties:
            GroupDescription: Allow HTTP traffic to Load Balancer
            SecurityGroupIngress: 
            - IpProtocol: tcp
              FromPort: 80
              ToPort: 80
              CidrIp: 0.0.0.0/0
            SecurityGroupEgress: 
            - IpProtocol: tcp
              FromPort: 80
              ToPort: 80
              CidrIp: 0.0.0.0/0
            VpcId: 
                Fn::ImportValue:
                    !Sub ${EnvironmentName}-VpcId
            Tags: 
                - Key: Name
                  Value: !Sub ${EnvironmentName} Load Balancer SecurityGroup

    WebServerSecurityGroup:
        Type: AWS::EC2::SecurityGroup
        Properties:
            GroupDescription: Allow HTTP and SSH traffic to Servers
            SecurityGroupIngress:
            - IpProtocol: tcp  # allow inbound HTTP traffic
              FromPort: 8080
              ToPort: 8080
              CidrIp: 0.0.0.0/0
            - IpProtocol: tcp  # allow inbound SSH traffic
              FromPort: 22
              ToPort: 22
              CidrIp: 173.49.58.93/32  # shoudl I limit to only my IP?
            SecurityGroupEgress:
            - IpProtocol: tcp
              FromPort: 0
              ToPort: 65535
              CidrIp: 0.0.0.0/0
            VpcId: 
                Fn::ImportValue:
                    !Sub ${EnvironmentName}-VpcId
            Tags:
                - Key: Name
                  Value: !Sub ${EnvironmentName} Web Servers Security Group

    S3ReadOnlyProfile:
        Type: AWS::IAM::InstanceProfile
        Properties: 
            InstanceProfileName: !Sub ${EnvironmentName}-Servers-S3-Access-Profile
            Roles:
                - EC2-S3-ReadOnly

    LaunchConfig:
        Type: AWS::AutoScaling::LaunchConfiguration
        Properties: 
            AssociatePublicIpAddress: false
            BlockDeviceMappings: 
                - DeviceName: dev/sdk
                  Ebs:
                    VolumeSize: 10
                    VolumeType: gp2
            IamInstanceProfile: !Ref S3ReadOnlyProfile
            ImageId: ami-003634241a8fcdec0 # Ubuntu 18
            # InstanceMonitoring: Boolean
            InstanceType: t2.medium # 2vCPU 4Gb Ram
            #  Key pair for EC2 SSH access
            # KeyName: String  
            SecurityGroups: [ !Ref WebServerSecurityGroup ]
            UserData:
                Fn::Base64: !Sub |
                    #!/bin/bash
                    apt-get update -y
                    apt-get install unzip awscli -y
                    apt-get install apache2 -y
                    systemctl start apache2.service
                    cd /var/www/html
                    aws s3 cp s3://udacity-demo-1/udacity.zip .
                    unzip -o udacity.zip
